

<script src="<?= BASE_ASSET; ?>/js/jquery.hotkeys.js"></script>

<script type="text/javascript">

//This page is a result of an autogenerated content made by running test.html with firefox.

function domo(){

 

   // Binding keys

   $('*').bind('keydown', 'Ctrl+e', function assets() {

      $('#btn_edit').trigger('click');

       return false;

   });



   $('*').bind('keydown', 'Ctrl+x', function assets() {

      $('#btn_back').trigger('click');

       return false;

   });

    

}





jQuery(document).ready(domo);

</script>

<!-- Content Header (Page header) -->

<section class="content-header">

   <h1>

      Vérification du Proforma      <small><?//= cclang('detail', ['Proforma']); ?> </small>

   </h1>

   <ol class="breadcrumb">

      <li><a href="#"><i class="fa fa-dashboard"></i> Accueil</a></li>

      <li class=""><a  href="<?= site_url('administrator/project_proforma'); ?>">Vйrification du Proforma</a></li>

      <li class="active"><?//= cclang('detail'); ?></li>

   </ol>

</section>

<!-- Main content -->

<section class="content">

  <?php
/*
   $project=$this->uri->segment(4);

   $client=$this->uri->segment(5);*/
 ?> 

   <div class="row" >

     

      <div class="col-md-12">

         <div class="box box-warning">

            <div class="box-body ">



               <!-- Widget: user widget style 1 -->

               <div class="box box-widget widget-user-2">

                 

                  <div class="form-horizontal" name="form_project_proforma" id="form_project_proforma" >

                     <?= form_open('', [

                            'name'    => 'form_list_proforma', 

                            'class'   => 'form-horizontal', 

                            'id'      => 'form_list_proforma', 

                            'enctype' => 'multipart/form-data', 

                            'method'  => 'POST'

                            ]); ?>

                <div class="content">

                     <div class="row">


                                      <?php

$this->db->select('*');
$this->db->from('pos_ibi_clients as c');
$this->db->join('pos_store_2_ibi_devis as d', 'c.ID_CLIENT = d.REF_CLIENT_DEVIS');
$this->db->where('ID_DEVIS',$this->uri->segment(4));

$query = $this->db->get();

   foreach ($query->result() as $row)  //Iterate through results
   {
      $nom = $row->NOM_CLIENT;
      $prenom = $row->PRENOM_CLIENT;
      $address = $row->ADRESSE_CLIENT;
      $email = $row->EMAIL_CLIENT;
      $telephone = $row->TEL_CLIENT;
      $nif = $row->STATE_CLIENT;
      $client=$row->STATE_CLIENT;
      //$created_by = $order[ 'order' ][0][ 'AUTHOR' ];
     
   }

?> 

                   <div class="col-md-6">

                     <div class="breadcumb pull-left">
                       <span>Client : </span>
        <div style="margin: 0px 2px 0px 0px;">
          <span class="bold">● <?php echo $nom.' '.$prenom;?></span>
        </div> 
        <div style="margin: 0px 2px 0px 0px;">
          <span>● Bujumbura-BURUNDI</span>
        </div>
        
        <div>
          <span style="margin: 0px 2px 0px 0px;">● Tel : <?php echo $telephone?></span><br>
          <span style="margin: 0px 2px 0px 0px;">● Email : <?php echo $email?></span>
        </div>
        <div>
          <span style="margin: 0px 2px 0px 0px;">● NIF : <?php echo $nif?></span>
        </div>
                     </div>
                     
                   </div>

                   <div class="col-md-6">

                    <div class="pull-right"><b>Date :</b><?php echo date("d-m-Y").' '.'<br/>'; ?></div>

                    
                        

                       <!--  <br/><input type="text" class="form-control col-sm-8 pull-right" name="reference" id="reference" placeholder="Ajouter n°  de reference" value=""> -->
                       
                    
                   </div>

            
                   
                 </div>

          <div class="form-group ">  

                   

                     <table border="0" style="width: 100%" class="table table_bordered">

                        <thead>

                        <tr>
                          
                          <th class="marge_">DESIGNATION</th>
                          <th class="marge_">REFERENCE</th>
                          
                          <th class="marge_ text-center">P.V</th>
                          <th colspan="" class="marge_ text-center">QTE DEVIS</th><th class="marge_ text-center">P.U</th><th class="marge_ text-center">P.T</th>
                        </tr>
                      </thead>
                       <?php

                  

                     ?>

                       <tbody>
<br><br>
                       <div class="form-group ">
                            <label for="TITRE_FICHE" class="col-sm-2 control-label">Titre proforma 
                            <i class="required">*</i>
                            </label>
                            <div class="col-sm-8">
                             <input type="hidden" class="form-control" name="client" value="<?= $client ?>">


                                <input type="text" class="form-control" name="titre_proforma" id="TITRE_FICHE" placeholder="Entrer un titre pour proforma" value="">
                                <small class="info help-block">
                                </small>
                            </div>
                        </div>







                         <!-- <input type="text" class="form-control" name="project_proforma_title" id="project_proforma_title" placeholder="Ajouter le titre du proforma" value="" style="display:;"><i class="required">*</i> -->


                        <?php


                          $total_HTVA=0;

                          $tot_HTVA=0;

                          $livraison=0;

                          $temps_installation=0;

                          $temps_test =0;

                          $total_price=0;

                          $total_prices=0;

                          $TVA = 0;

                          $verification=0;

                          $grand_total = 0;


$this->db->select('REF_PRODUCT_CODEBAR_DEVIS_PROD,QUANTITE_DEVIS_PROD,UNIT_DEVIS_PROD,PRIX_DEVIS_PROD,NAME_DEVIS_PROD');
$this->db->from('pos_store_2_ibi_devis_produits');
$this->db->where('REF_DEVIS_CODE_DEVIS_PROD',$this->uri->segment(4));

$query = $this->db->get();

   foreach ($query->result() as $request)  //Iterate through results
   {





/*

                          $requete=$this->db->query('SELECT * FROM project p,project_clients c,project_produits pr, project_articles a WHERE p.project_id=pr.project_reference AND c.project_clients_id=p.project_client_discussion_id AND a.project_article_id=pr.project_article_id AND pr.project_produits_category=0 AND  p.project_id="'.$project.'" AND c.project_clients_id="'.$client.'"');



                           foreach ($requete->result() as  $request) {*/

                        $total_price1=($request->QUANTITE_DEVIS_PROD * $request->PRIX_DEVIS_PROD);

                            $total_prices +=$total_price1;

                          


                         ?>
                         <tr>
                           <td class="td_width">

                           
                            <!-- 
                            <input type="hidden" class="form-control" name="garantie" id="garantie" placeholder="Garantie" value="">
                            <input type="hidden" class="form-control" name="validite" id="validite" placeholder="Validite" value="">
                            <input type="hidden" class="form-control" name="paiement" id="paiement" placeholder="Conditions depaiement" value=""> -->


                            <input type="hidden" class="form-control" name="design[]" id="design" placeholder="Design" value="<?php echo $request->NAME_DEVIS_PROD; ?>"><?php echo $request->NAME_DEVIS_PROD; ?></td>
                           <td colspan="" class="marge"><input type="hidden" class="form-control" name="reference[]" id="reference" placeholder="Reference" value="<?php echo $request->REF_PRODUCT_CODEBAR_DEVIS_PROD; ?>"><?php echo $request->REF_PRODUCT_CODEBAR_DEVIS_PROD; ?></td>

                           <td class="text-center"><?php echo number_format($request->PRIX_DEVIS_PROD,0," "," "); ?></td>

                          

                            <td class="marge text-center quantite_"><input type="hidden" class="form-control" name="quantite[]" id="quantite" placeholder="Quantite" value="<?php echo $request->QUANTITE_DEVIS_PROD; ?>"><?php echo $request->QUANTITE_DEVIS_PROD; ?>
                          &nbsp;&nbsp;<span class="fa fa-check-square" aria-hidden="true" title="" style="color:#26edd2;"></td>
                          <?php  //} ?>





                            <td class="marge text-center"><input type="number" class="form-control unit_price" name="unit_price[]" id="unit_price" idprix="<?php echo $request->NAME_DEVIS_PROD;?>" prixRest="<?php echo $request->PRIX_DEVIS_PROD; ?>" placeholder="Prix de vente" min="<?php echo $request->PRIX_DEVIS_PROD; ?>" value="<?php echo $request->PRIX_DEVIS_PROD; ?>"></td>

                           <td class="marge text-center tot_price"><input type="text" class="form-control" name="total_price[]" readonly id="total_price" value="<?php echo ($total_price1); ?>"></td>
                         
                           

                          </tr>
                          

                        <?php 
                         
                     } 
  
                 ?>
                        <tr>
                            <td style="text-align: right;" colspan="5"><b>Total HTVA</b></td>
                            <td style="text-align: center;"><b><?php echo '<span class="tot_HTVA">'. round($tot_HTVA).'</span> FBU'; ?></b></td>
                            
                          </tr>

                      <tr>
                         <td style="text-align: right;" colspan="5"><b>TVA (18%)</b></td>
                         <td style="text-align: center;"><b><?php echo '<span class="tva">'.(round($TVA)).'</span> FBU' ; ?></b></td>

                      </tr>

                      <tr>
                         <td style="text-align: right;" colspan="5"><b>TVAC</b></td>
                         <td style="text-align: center;"><b><?php echo '<span class="tva">'.(round($TVA)).'</span> FBU' ; ?></b></td>

                      </tr>

                      </tbody>
                    
                   </table>
                 

                                  
        </div>
                  
                    <br>

                    <div class="message"></div>

                   <div class="row-fluid col-md-7">

                           <!-- <button class="btn btn-flat btn-primary btn_save btn_action" id="btn_save" data-stype='stay' title="<?= cclang('save_button'); ?> (Ctrl+s)">

                            <i class="fa fa-save" ></i> <?= cclang('save_button'); ?>

                            </button> -->

                            
                            <button class="btn btn-flat btn-primary btn_save btn_action btn_save_back" type="submit" id="btn_save" data-stype='back' title="Créer un proforma">

                            <i class="fa fa-save" ></i> Enregistrer

                            </button>

                            <a class="btn btn-flat btn-default btn_action" id="btn_cancel" title="<?= cclang('cancel_button'); ?> (Ctrl+x)">

                            <i class="fa fa-undo" ></i> Retour

                            </a>

                            <span class="loading loading-hide">

                            <img src="<?= BASE_ASSET; ?>/img/loading-spin-primary.svg"> 

                            <i><?= cclang('loading_saving_data'); ?></i>

                            </span>

                        </div>

                      </div>

                     <?= form_close(); ?>

                  </div>

               </div>

            </div>

            <!--/box body -->

         </div>

         <!--/box -->



      </div>

   </div>

</section>

<!-- /.content -->

<script>

    $(document).ready(function(){

     /* qte=$('.quantite1_').val();

        price=$('.unit_price1_').val();
        prix=qte*price;

        $('.total_price1_').val(prix);*/

         

      $('#btn_cancel').click(function(){

        swal({

            title: "<?= cclang('are_you_sure'); ?>",

            text: "<?= cclang('data_to_be_deleted_can_not_be_restored'); ?>",

            type: "warning",

            showCancelButton: true,

            confirmButtonColor: "#DD6B55",

            confirmButtonText: "Yes!",

            cancelButtonText: "No!",

            closeOnConfirm: true,

            closeOnCancel: true

          },

          function(isConfirm){

            if (isConfirm) {

              window.location.href = BASE_URL + 'administrator/project_proforma/add_new_proforma';

            }

          });

    

        return false;

      }); /*end btn cancel*/



      // $(document).on('keyup','#unit_price',function(){
      //   var unit_price = $('#unit_price').val();
      //   // var total_price = $('#total_price').val();
      //   var quantite = $('#quantite').val();

      //   $.ajax({
      //     url: BASE_URL +'/administrator/project_proforma/save_unit_price',
      //     type: 'POST',
      //     data:{unit_price:unit_price,quantite:quantite},
      //     dataType:'json',
      //     success: function(data){

      //       console.log(data.msg);

      //       $('#total_price').val(data.msg);

      //     }
      //   });
      // });

      // $(document).on('keyup','unit_price1',function(){
      //   alert();
      // });
    

      $('.btn_save').click(function(){

        avoid_multi_click_btn('btn_save', 15000);

        $('.message').fadeOut();

    //alert('ok');

    /*swal({

            title: "Vous voulez confirmer ?",

            text: "",

            type: "warning",

            showCancelButton: true,

            confirmButtonColor: "#DD6B55",

            confirmButtonText: "Oui",

            cancelButtonText: "Non",

            closeOnConfirm: true,

            closeOnCancel: true

          },

          function(isConfirm){

            if (isConfirm) {*/

            

        var form_project = $('#form_list_proforma');

        var data_post = form_project.serializeArray();

        var save_type = $(this).attr('data-stype');



        data_post.push({name: 'save_type', value: save_type});

    

        $('.loading').show();

    

        $.ajax({

          url: BASE_URL + '/administrator/project_proforma/add_save',

          type: 'POST',

          dataType: 'json',

          data: data_post,

        })




        .done(function(res) {

          if(res.success) {

            

            if (save_type == 'back') {

              window.location.href = res.redirect;

              return;

            }

    

            $('.message').printMessage({message : res.message});

            $('.message').fadeIn();

            resetForm();

            $('.chosen option').prop('selected', false).trigger('chosen:updated');

                

          } else {

            $('.message').printMessage({message : res.message, type : 'warning'});

          }

    

        })



        .fail(function() {

          $('.message').printMessage({message : 'Error save data', type : 'warning'});

        })

        .always(function() {

          $('.loading').hide();

          $('html, body').animate({ scrollTop: $(document).height() }, 2000);

        });

     /* }

   });*/
    

        return false;



      }); /*end btn save*/

      

     $('.unit_price').on('keyup',function(){


        var id = $(this).attr('idprix');

        var quantite=0;
        var prixRest=$(this).attr('prixRest');
        var price=$(this).val();
        var total_htva=0;
        
        //alert(prixRest);
        /*if ((prixRest.length) <=(price.length)) {*/
        /*if(prixRest < price){
          $('#unit_price'+id+'').val(price);
        }else{
          $('#unit_price'+id+'').val(prixRest);
        }*/
        
        

        var pt=0;

        tot_htva=parseFloat($('.tot_HTVA').html());

        var old_tot_prix=$(this).parent().parent().children('.tot_price').children('#total_price').val();

        var price=$(this).val();

        //alert(tot_htva);

        quantite=$(this).parent().parent().children('.quantite_').children('#quantite').val();

        price=$(this).val();

        pt=quantite*price;

        if(pt!==null && pt>0)
        {
          $(this).parent().parent().children('.tot_price').children('#total_price').val(pt);

          var tot_new=pt-old_tot_prix;

          $('.tot_HTVA').html(tot_new+tot_htva);

          var calcul_tva=parseFloat($('.tot_HTVA').html());

          $('.tva').html(Math.round((calcul_tva*18)/100));

          var calcul_tot_gen=parseFloat($('.tot_HTVA').html())+parseFloat($('.tva').html());

          $('.grandTotal').html(Math.round(calcul_tot_gen));

           $('#grand_total').val(Math.round(calcul_tot_gen));

          //alert(tot_new);


          
        }

        else 
        {
          $(this).parent().parent().children('.tot_price').children('#total_price').val('0');
        }

/*}

else{
  $('#unit_price'+id+'').val(prixRest);
}*/
 }); 


     

   $('body').on('change','.unit_price',function(){


        var id = $(this).attr('idprix');

        var quantite=0;
        var prixRest=$(this).attr('prixRest');
        var price=$(this).val();
       /* if(prixRest < price){
          $('#unit_price'+id+'').val(price);
        }else{
          $('#unit_price'+id+'').val(prixRest);
        }*/
        
        

        var pt=0;

        quantite=$(this).parent().parent().children('.quantite_').children('#quantite').val();

        price=$(this).val();

        pt=quantite*price;

        if(pt!==null && pt>0)
        {
          $(this).parent().parent().children('.tot_price').children('#total_price').val(pt);
        }

        else 
        {
          $(this).parent().parent().children('.tot_price').children('#total_price').val('0');
        }


 });


  $('body').on('keyup','#unit_price1',function(){

  //alert('ok');

        var qte=0;

        var prix=0;

        var total_htva=0;

        var tva=0;

        var tot_htva=0;

        var tot_gen=0;

        var tot_gen_value=0;

        qte=$('.quantite1_').val();

        tot_htva=parseFloat($('.tot_HTVA').html());

        tva=parseFloat($('.tva').html());

        tot_gen=parseFloat($('.grandTotal').html());

        tot_gen_value=parseFloat($('#grand_total').val());

        price=$(this).val();

        prix=qte*price;

        var old_tot_price=$('.total_price1_').val();

        var tot_php=tot_htva-old_tot_price;


        if(prix!==null && prix>0)
        {

         

          $('.total_price1_').val(prix);



          $('.tot_HTVA').html(tot_php+parseFloat($('.total_price1_').val()));

          var tva_php=$('.tot_HTVA').html(tot_php+parseFloat($('.total_price1_').val()));

          var calcul_tva=parseFloat($('.tot_HTVA').html());

          $('.tva').html(Math.round((calcul_tva*18)/100));

          var calcul_tot_gen=parseFloat($('.tot_HTVA').html())+parseFloat($('.tva').html());

          $('.grandTotal').html(Math.round(calcul_tot_gen));

           $('#grand_total').val(Math.round(calcul_tot_gen));



        }

        else 
        {
          $('.total_price1_').val('0');
        }

 });
    

$('body').on('keyup','#quantite1',function(){

  //alert('ok');

        var qte=0;

        var tva=0;

        var tot_gen=0;

        var tot_gen_value=0;

        var prix=0;

        qte=$('.quantite1_').val();

        price=$('.unit_price1_').val();

        tot_htva=parseFloat($('.tot_HTVA').html());

        tva=parseFloat($('.tva').html());

        tot_gen=parseFloat($('.grandTotal').html());

        tot_gen_value=parseFloat($('#grand_total').val());

        //alert(tot_gen_value);

        prix=qte*price;

        var old_tot_price=$('.total_price1_').val();

        var tot_php=tot_htva-old_tot_price;

        if(prix!==null && prix>0)
        {
          $('.total_price1_').val(prix);

          $('.tot_HTVA').html(tot_php+parseFloat($('.total_price1_').val()));

          var calcul_tva=parseFloat($('.tot_HTVA').html());

          $('.tva').html(Math.round((calcul_tva*18)/100));

          var calcul_tot_gen=parseFloat($('.tot_HTVA').html())+parseFloat($('.tva').html());

          $('.grandTotal').html(Math.round(calcul_tot_gen));

           $('#grand_total').val(Math.round(calcul_tot_gen));

          

        }

        else 
        {
          $('.total_price1_').val('0');
        }

 });


 $('body').on('change','#unit_price1',function(){

  //alert('ok');

        var qte=0;

        var prix=0;

        var total_htva=0;

        var tva=0;

        var tot_htva=0;

        var tot_gen=0;

        var tot_gen_value=0;

        qte=$('.quantite1_').val();

        tot_htva=parseFloat($('.tot_HTVA').html());

        tva=parseFloat($('.tva').html());

        tot_gen=parseFloat($('.grandTotal').html());

        tot_gen_value=parseFloat($('#grand_total').val());

        price=$(this).val();

        prix=qte*price;

        var old_tot_price=$('.total_price1_').val();

        var tot_php=tot_htva-old_tot_price;


        if(prix!==null && prix>0)
        {

         

          $('.total_price1_').val(prix);



          $('.tot_HTVA').html(tot_php+parseFloat($('.total_price1_').val()));

          var tva_php=$('.tot_HTVA').html(tot_php+parseFloat($('.total_price1_').val()));

          var calcul_tva=parseFloat($('.tot_HTVA').html());

          $('.tva').html(Math.round((calcul_tva*18)/100));

          var calcul_tot_gen=parseFloat($('.tot_HTVA').html())+parseFloat($('.tva').html());

          $('.grandTotal').html(Math.round(calcul_tot_gen));

           $('#grand_total').val(Math.round(calcul_tot_gen));



        }

        else 
        {
          $('.total_price1_').val('0');
        }

 });


    

$('body').on('change','#quantite1',function(){

  //alert('ok');

        var qte=0;

        var tva=0;

        var tot_gen=0;

        var tot_gen_value=0;

        var prix=0;

        qte=$('.quantite1_').val();

        price=$('.unit_price1_').val();

        tot_htva=parseFloat($('.tot_HTVA').html());

        tva=parseFloat($('.tva').html());

        tot_gen=parseFloat($('.grandTotal').html());

        tot_gen_value=parseFloat($('#grand_total').val());

        //alert(tot_gen_value);

        prix=qte*price;

        var old_tot_price=$('.total_price1_').val();

        var tot_php=tot_htva-old_tot_price;

        if(prix!==null && prix>0)
        {
          $('.total_price1_').val(prix);

          $('.tot_HTVA').html(tot_php+parseFloat($('.total_price1_').val()));

          var calcul_tva=parseFloat($('.tot_HTVA').html());

          $('.tva').html(Math.round((calcul_tva*18)/100));

          var calcul_tot_gen=parseFloat($('.tot_HTVA').html())+parseFloat($('.tva').html());

          $('.grandTotal').html(Math.round(calcul_tot_gen));

           $('#grand_total').val(Math.round(calcul_tot_gen));

          

        }

        else 
        {
          $('.total_price1_').val('0');
        }

 });
    

    

    }); /*end doc ready*/

function avoid_multi_click_btn(btn_id, period)
  {
      $('#'+btn_id).attr('disabled', true);

      var my_interval = setInterval(function(){

        $('#'+btn_id).attr('disabled', false);

        clearInterval(my_interval);

      }, period);
  }

</script>